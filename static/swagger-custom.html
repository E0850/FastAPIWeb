<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Bugzy API — Custom Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Swagger UI CSS (proper tag) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.11.0/swagger-ui.css">
  <!-- Your dark theme overrides -->
  <link rel="stylesheet" href="/static/swagger-dark.css?v=36">

  <style>
    /* Hide built-in Authorize button and the topbar Explore URL input */
    .swagger-ui .auth-wrapper,
    .swagger-ui .btn.authorize { display: none !important; }
    .swagger-ui .topbar .download-url-wrapper { display: none !important; }

    /* Top login strip */
    .login-strip {
      display: flex; gap: 8px; align-items: center;
      background: #0d1117; border-bottom: 1px solid #4b5563;
      padding: 10px 16px; position: sticky; top: 0; z-index: 999;
    }
    .login-strip input {
      background-color: #1e293b; color: #fff; border: 1px solid #4b5563;
      padding: 6px 8px; border-radius: 4px; min-width: 220px;
    }
    .login-strip button {
      background: transparent; color: #93c5fd; border: 1px solid #4b5563;
      padding: 6px 10px; border-radius: 6px; cursor: pointer;
    }
    .login-strip button:hover { background: #1e293b; border-color: #93c5fd; }
    .login-status { margin-left: auto; color: #cfd8dc; font-size: 12px; }
    .login-status .ok { color: #22c55e; } .login-status .fail { color: #ef4444; }

    /* Overview teaser */
    .api-overview { max-width: 1000px; margin: 16px auto; padding: 0 16px; }
    .api-overview h2 { margin: 8px 0; font-size: 20px; font-weight: 700; color: #fff; }
    .api-overview .desc {
      color: #cfd8dc; line-height: 1.6; font-size: 14px;
      display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; overflow: hidden;
    }
    .api-overview .desc.expanded { -webkit-line-clamp: unset; display: block; }
    .api-overview .toggle-btn {
      margin-top: 6px; background: transparent; color: #93c5fd; border: 1px solid #4b5563;
      padding: .35rem .6rem; border-radius: 6px; cursor: pointer; font-size: 13px;
    }
    .api-overview .toggle-btn:hover { background: #1e293b; border-color: #93c5fd; }
    .api-overview .cite { margin-top: 8px; font-size: 12px; color: #93c5fd; }

    /* Container for Swagger */
    #swagger-ui { margin-top: 8px; }
  </style>
</head>
<body class="swagger-ui" id="docs-custom">

  <!-- === Login Strip (email + password) === -->
  <div class="login-strip">
    <strong style="color:#fff;">Login (OAuth2 Password)</strong>
    <input id="email" type="email" placeholder="Email (username)" autocomplete="username">
    <input id="password" type="password" placeholder="Password" autocomplete="current-password">
    <button id="btnLogin">Login</button>
    <button id="btnLogout">Logout</button>
    <div class="login-status" id="loginStatus">Not logged in</div>
  </div>


<!-- === Overview teaser / expand (will be moved below title by script) === -->
<div class="api-overview" id="apiOverview">

  <!-- Scoped bullet style: small squares for all lists in this section -->
  <style>
    /* Apply to all lists inside the overview/cite blocks only */
    #apiOverview ul,
    #apiOverview ol,
    #apiOverview .desc ul,
    #apiOverview .desc ol,
    #apiOverview .cite ul {
      list-style-type: square;      /* small square bullets */
      padding-left: 1.15rem;        /* tidy indent */
      margin-left: 0;
    }
    /* Make the squares visually smaller and match dark theme */
    #apiOverview ul li::marker,
    #apiOverview ol li::marker,
    #apiOverview .cite ul li::marker {
      font-size: 0.8em;
      color: #cfd8dc;               /* subtle light grey; adjust if you want more pop */
    }
  </style>

  <h2>API Platform Overview and Key Features:</h2>
  <div id="overviewDesc" class="desc">
    <p>
      The API platform is built on FastAPI with SQLAlchemy ORM, uses Pydantic for data validation, and Alembic for database migrations.
      It supports static files and a custom Swagger UI; in production, CORS is restricted to trusted origins and secure cookie posture is enforced.
      The current implementation delivers first‑party RS256‑signed tokens, Okta OIDC with Authorization Code + PKCE, guarded API docs, and refresh‑token hygiene.
    </p>

    <h3>Security Highlights (Current State)</h3>
    <ul>
      <li>OAuth2 Authorization Code + PKCE implemented for browser/client flows; nonce and <code>at_hash</code> verified during callback.</li>
      <li>Enterprise IdP integration via Okta OIDC (metadata discovery, JWKS validation, issuer/audience enforced; optional Okta token cookies).</li>
      <li>Asymmetric JWT signing (RS256) with <code>kid</code> header; public JWKS exposed at <code>/.well-known/jwks.json</code>; RSA keys loaded from environment variables.</li>
      <li>Refresh-token hygiene: rotation on use, reuse detection, and server-side revocation by bumping <em>TokenVersion</em>.</li>
      <li>Bearer-protected routes controlled by <code>REQUIRE_CLIENT_AUTH</code> with a global auth dependency.</li>
      <li>User activation checks and token invalidation/versioning via <em>TokenVersion</em> on credential changes.</li>
      <li>Fine-grained RBAC with role-to-scope mapping and route-level scope enforcement.</li>
      <li>Rate limiting and login protections using SlowAPI with sticky per-identity keys, a custom 429 handler, and an “attempts remaining” counter.</li>
    </ul>

    <h3>Data &amp; UX Features</h3>
    <ul>
      <li>CRUD endpoints for Orders, Customers, Invoices, and Agreements.</li>
      <li>Email-based user operations (CRUD + admin).</li>
      <li>Pagination with limit/offset and full-field search across multiple endpoints.</li>
      <li>Consistent error handling for 404, 409, 400, 401, and 500 responses with structured logging.</li>
    </ul>

    <h3>Deployment &amp; Operations</h3>
    <ul>
      <li>Hosted on Render with HTTPS enforced; API docs access is guarded.</li>
      <li>Database on Neon PostgreSQL via <code>psycopg2</code> (SQLAlchemy engine with <code>pool_pre_ping=True</code>).</li>
      <li>Alembic migrations for schema versioning (autogenerate and upgrade steps documented).</li>
      <li>Health check endpoint at <code>/healthz</code>.</li>
      <li>JWKS exposure for token validation at <code>/.well-known/jwks.json</code>.</li>
      <li>RSA key-rotation plan (PLANNED; target Feb&nbsp;2025) with dual-sign overlap considerations.</li>
      <li>Custom Swagger theming (dark mode &amp; branding) via CDN with CSS and an HTML docs page; optional <em>Authorize</em> button per UX preference.</li>
    </ul>

    <h3>Optional Hardening (Recommended Next)</h3>
    <ul>
      <li>Add <code>iss</code> and <code>aud</code> to first‑party RS256 access tokens and enforce locally during verification.</li>
      <li>Automate RSA key rotation (new <code>kid</code>, publish JWKS, switch <code>JWT_ACTIVE_KID</code>, maintain overlap window, smoke tests).</li>
      <li>Observability: request IDs, structured logging fields (trace/user/sub), and minimal audit logs for write operations.</li>
      <li>Security headers &amp; secrets management: strict cookie flags and a Content‑Security‑Policy for docs; standardized secret rotation cadence.</li>
    </ul>
  </div>
  <button id="toggleOverview" class="toggle-btn" aria-expanded="false" aria-controls="overviewDesc">Show more</button>

  <div class="cite">
    <h2>About the Author:</h2>
      <ul>
        <li><a href="https://www.facebook.com/share/1CxK136BPF/" target="_blank" rel="noopener noreferrer">https://www.facebook.com/share/1CxK136BPF/</a></li>
        <li><a href="https://www.linkedin.com/in/fernando-losantos-33a746124/" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/in/fernando-losantos-33a746124/</a></li>
      </ul>
  </div>
</div>
  
  </div>

  <!-- === Swagger UI root === -->
  <div id="swagger-ui"></div>

  <!-- Swagger UI JS (proper tags) -->
  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.11.0/swagger-ui-bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.11.0/swagger-ui-standalone-preset.js"></script>

  <script>
    // --- Token store helpers ---
    const TOKEN_KEY = 'bugzy_access_token';
    const setToken = (tok) => { try { localStorage.setItem(TOKEN_KEY, tok || ''); } catch(e){} };
    const getToken = () => { try { return localStorage.getItem(TOKEN_KEY) || ''; } catch(e){ return ''; } };
    const isLoggedIn = () => !!getToken();
    function updateStatus(ok, msg) {
      const el = document.getElementById('loginStatus');
      el.innerHTML = ok ? `<span class="ok">Logged in</span>${msg ? ' — ' + msg : ''}` :
                          `<span class="fail">Not logged in</span>${msg ? ' — ' + msg : ''}`;
    }

    // --- Initialize Swagger UI against your OpenAPI ---
    const ui = SwaggerUIBundle({
      url: '/openapi.json',               // FastAPI's schema endpoint
      dom_id: '#swagger-ui',
      deepLinking: true,
      presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
      layout: "StandaloneLayout",
      requestInterceptor: (req) => {
        const tok = getToken();
        if (tok) {
          req.headers = req.headers || {};
          req.headers['Authorization'] = `Bearer ${tok}`;
        }
        return req;
      },
    });

    // === Relocate overview block below the Swagger title & set up toggle ===
    (function () {
      function moveOverview() {
        const overview = document.getElementById('apiOverview');
        const titleAnchor = document.querySelector('.information-container.wrapper .info .main');
        if (!overview || !titleAnchor) return false;
        titleAnchor.insertAdjacentElement('afterend', overview);
        return true;
      }
      if (!moveOverview()) {
        const check = setInterval(() => { if (moveOverview()) clearInterval(check); }, 100);
        setTimeout(() => clearInterval(check), 8000);
      }
      const desc = document.getElementById('overviewDesc');
      const btn = document.getElementById('toggleOverview');
      if (desc && btn) {
        btn.addEventListener('click', () => {
          const expanded = desc.classList.toggle('expanded');
          btn.textContent = expanded ? 'Show less' : 'Show more';
          btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        });
      }
    })();

    // --- Login logic (Password Flow -> POST /token) ---
    async function login() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pw = document.getElementById('password').value;
      if (!email || !pw) { updateStatus(false, 'Provide email and password'); return; }

      try {
        const form = new URLSearchParams({ username: email, password: pw, grant_type: 'password' });
        const r = await fetch('/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString(),
        });

        let payload = null;
        try { payload = await r.json(); } catch (_) { /* non-JSON error body */ }

        if (!r.ok) {
          const msg = payload?.message || payload?.detail || payload?.code || `HTTP ${r.status}`;
          setToken('');
          updateStatus(false, msg);
          return;
        }

        const tok = payload?.access_token || '';
        if (!tok) {
          setToken('');
          updateStatus(false, 'No access_token in response');
          return;
        }

        setToken(tok);
        updateStatus(true, 'Token stored');
      } catch (e) {
        setToken('');
        updateStatus(false, 'Login error: ' + e);
      }
    }

    function logout() {
      setToken('');
      updateStatus(false, 'Logged out');
    }

    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnLogout').addEventListener('click', logout);

    // Initial status
    updateStatus(isLoggedIn(), isLoggedIn() ? 'Token loaded from storage' : '');
  </script>
</body>
</html>
